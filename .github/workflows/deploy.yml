name: Deploy to GCP (Backend and Frontend)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - '**/README**'
      - '**/test**'
      - '**/Test**'

permissions:
  contents: 'read'
  id-token: 'write'  # Required for Workload Identity
  packages: 'read'   # Required for GitHub Container Registry

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Use a larger runner for faster execution if available
    # runs-on: ubuntu-latest-4-cores  # Uncomment if you have access to larger runners

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Updated to latest version
        with:
          fetch-depth: 2  # Needed for git diff

      - name: Check for changes
        id: changes
        run: |
          echo "backend=$(git diff --name-only HEAD~1 HEAD | grep -q '^backend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "frontend-nextjs=$(git diff --name-only HEAD~1 HEAD | grep -q '^frontend-nextjs/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "docker-compose=$(git diff --name-only HEAD~1 HEAD | grep -q 'docker-compose.yml\|Caddyfile' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "config_data=$(git diff --name-only HEAD~1 HEAD | grep -q '^frontend-nextjs/public/data/players.json$\|^config/season_start.json$' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Authenticate to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '>= 363.0.0'

      - name: Create all secret files
        run: |
            echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" > .dns_secrets

            echo "MATCHMAKING_TOKEN=${{secrets.AUTH_TOKEN}}" > .frontend_secrets
            echo "SERVERACPASS=${{ secrets.SERVERACPASS }}" >> .frontend_secrets
          
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" > .backend_secrets
            echo "AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}" >> .backend_secrets
            echo "DB_USER=${{ secrets.DB_USER }}" >> .backend_secrets
            echo "RCON_PASSWORD=${{ secrets.RCON_PASSWORD }}" >> .backend_secrets
          
            echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" > .my_sql_secrets
            echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> .my_sql_secrets
            echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .my_sql_secrets
          
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" > .pg_secrets
            echo "POSTGRES_READONLY_PASSWORD=${{ secrets.POSTGRES_READONLY_PASSWORD }}" >> .pg_secrets
          
            echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json

      - name: Copy config files to GCP VM
        run: |
          # Stop backend, remove mistaken players.json directory, recreate structure with sudo, fix ownership (no pre-touch)
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
            --command="cd ~ && sudo docker compose stop backend && sudo rm -rf ~/frontend-nextjs/public/data/players.json && sudo mkdir -p ~/frontend-nextjs/public/data ~/config && sudo chown -R runner:runner ~/frontend-nextjs/public/data ~/config" \
            --ssh-key-expire-after=1m
          
          # Copy main config files
          gcloud compute scp \
            --zone=${{ secrets.GCP_ZONE }} \
            ./Caddyfile \
            ./docker-compose.yml \
            ./.dns_secrets \
            ./.backend_secrets \
            ./.frontend_secrets \
            ./.my_sql_secrets \
            ./.pg_secrets \
            ./credentials.json \
            ${{ secrets.GCP_VM_NAME }}:~/ \
            --ssh-key-expire-after=1m
          
          # Copy data files together
          gcloud compute scp \
            --zone=${{ secrets.GCP_ZONE }} \
            ./frontend-nextjs/public/data/players.json \
            ./config/season_start.json \
            ${{ secrets.GCP_VM_NAME }}:~/ \
            --ssh-key-expire-after=1m
          
          # Move files to correct locations
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
            --command="mv ~/players.json ~/frontend-nextjs/public/data/ && mv ~/season_start.json ~/config/" \
            --ssh-key-expire-after=1m

      - name: Ensure backend running (if only data changed)
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
            --command="cd ~ && (sudo docker compose ps backend | grep -q Up || DOCKER_BUILDKIT=1 COMPOSE_DOCKER_CLI_BUILD=1 sudo -E docker compose up -d --no-pull backend)" \
            --ssh-key-expire-after=1m

      - name: Set strict permissions on VM
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
            --command="chmod 600 ~/.dns_secrets ~/.backend_secrets ~/.frontend_secrets ~/.my_sql_secrets ~/.pg_secrets" \
            --ssh-key-expire-after=1m

      - name: Cleanup local secrets
        run: rm -f .dns_secrets .backend_secrets .frontend_secrets .my_sql_secrets .pg_secrets credentials.json

      - name: Update and start containers
        run: |
          SERVICES_TO_UPDATE=""
          if [[ "${{ steps.changes.outputs.backend }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES_TO_UPDATE="$SERVICES_TO_UPDATE backend"
          fi
          if [[ "${{ steps.changes.outputs.frontend-nextjs }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES_TO_UPDATE="$SERVICES_TO_UPDATE frontend-nextjs"
          fi
          if [[ "${{ steps.changes.outputs.docker-compose }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # If docker-compose changed, restart all services
            gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
              --command="echo '${{ secrets.GITHUB_TOKEN }}' | sudo -S docker login ghcr.io -u ${{ github.actor }} --password-stdin && sudo docker compose -f ~/docker-compose.yml pull && sudo docker compose -f ~/docker-compose.yml up -d"
          elif [[ -n "$SERVICES_TO_UPDATE" ]]; then
            # Only update specific services
            gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
              --command="echo '${{ secrets.GITHUB_TOKEN }}' | sudo -S docker login ghcr.io -u ${{ github.actor }} --password-stdin && sudo docker compose -f ~/docker-compose.yml pull $SERVICES_TO_UPDATE && sudo docker compose -f ~/docker-compose.yml up -d $SERVICES_TO_UPDATE"
          else
            echo "No services need to be updated"
          fi

      - name: Invalidate stats timestamp if config data changed
        if: steps.changes.outputs.config_data == 'true'
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} --zone=${{ secrets.GCP_ZONE }} \
            --command="sudo docker compose -f ~/docker-compose.yml exec backend bash -c 'rm -f /app/last_timestamp.txt' && sudo docker compose -f ~/docker-compose.yml restart backend" \
            --ssh-key-expire-after=1m
